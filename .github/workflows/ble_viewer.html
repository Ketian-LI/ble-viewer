<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <title>UNO R4 BLE æ•°æ®æ¥æ”¶ä¸è¾“å‡º</title>
  <style>
    body { font-family: sans-serif; padding: 16px; }
    #log {
      width: 100%;
      height: 300px;
      border: 1px solid #ccc;
      white-space: pre;
      overflow: auto;
      padding: 8px;
      box-sizing: border-box;
    }
  </style>
</head>
<body>
  <h1>UNO R4 BLE æ•°æ®æ¥æ”¶</h1>
  <button id="btnConnect">è¿æ¥è“ç‰™</button>
  <button id="btnClear">æ¸…ç©ºæ˜¾ç¤º</button>

  <h2>æ”¶åˆ°çš„æ•°æ®ï¼ˆè¿™æ˜¯ä½ è¯´çš„â€œå†è¾“å‡ºâ€ä¹‹ä¸€ï¼‰</h2>
  <div id="log"></div>

  <script>
    // ğŸ‘‡ æ¢æˆä½  Arduino é‡Œç”¨çš„ UUID
    const serviceUUID = '12345678-1234-5678-1234-56789abcdef0';
    const charUUID    = '12345678-1234-5678-1234-56789abcdef1';

    const logDiv = document.getElementById('log');
    const btnConnect = document.getElementById('btnConnect');
    const btnClear = document.getElementById('btnClear');

    let characteristic = null;

    function log(text) {
      logDiv.textContent += text + '\n';
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log(text);
    }

    // è¿æ¥ BLE è®¾å¤‡
    async function connectBLE() {
      try {
        const device = await navigator.bluetooth.requestDevice({
          filters: [{ name: 'UNO_R4_BLE' }],  // å¦‚æœåå­—ä¸åŒï¼Œæ”¹è¿™é‡Œ
          optionalServices: [serviceUUID]
        });

        const server = await device.gatt.connect();
        const service = await server.getPrimaryService(serviceUUID);
        characteristic = await service.getCharacteristic(charUUID);

        await characteristic.startNotifications();
        characteristic.addEventListener(
          'characteristicvaluechanged',
          handleNotification
        );

        log('âœ… å·²è¿æ¥ï¼š' + device.name);
      } catch (err) {
        console.error(err);
        log('âŒ è¿æ¥å¤±è´¥ï¼š' + err);
      }
    }

    // ğŸ”¥ğŸ”¥ğŸ”¥ æ‰€æœ‰æ”¶åˆ°çš„æ•°æ®éƒ½ä¼šä»è¿™é‡Œâ€œè·¯è¿‡â€
    function handleNotification(event) {
      const value = event.target.value;
      const decoder = new TextDecoder();
      const text = decoder.decode(value); // å¦‚æœä½ å‘çš„æ˜¯å­—ç¬¦ä¸²
      // const num = value.getUint16(0, true); // å¦‚æœä½ å‘çš„æ˜¯æ•´æ•°

      // 1ï¼‰å…ˆåœ¨ç½‘é¡µä¸Šè¾“å‡ºï¼ˆä½ ç°åœ¨å·²ç»çœ‹å¾—åˆ°çš„é‚£ç§æ•ˆæœï¼‰
      log('æ”¶åˆ°ï¼š' + text);

      // 2ï¼‰åœ¨è¿™é‡Œåšâ€œå†æ¬¡è¾“å‡ºâ€çš„åŠ¨ä½œï¼š
      //    ä½ å¯ä»¥é€‰ä¸€ç§æ–¹å¼â€”â€”ä¿å­˜æ–‡ä»¶ / å‘åˆ°æœåŠ¡å™¨ / è½¬ç»™åˆ«çš„ç¨‹åº

      // ç¤ºä¾‹ Aï¼šè¿½åŠ åˆ°ä¸€ä¸ªéšè—æ•°ç»„ï¼Œåé¢ç‚¹æŒ‰é’®å¯¼å‡º CSV
      // receivedData.push(text);

      // ç¤ºä¾‹ Bï¼šé€šè¿‡ HTTP POST å‘åˆ°ä½ çš„æœåŠ¡å™¨
      // fetch('https://your-server.example.com/api/data', {
      //   method: 'POST',
      //   headers: { 'Content-Type': 'application/json' },
      //   body: JSON.stringify({ value: text, time: Date.now() })
      // });

      // ç¤ºä¾‹ Cï¼ˆè¿›é˜¶ï¼‰ï¼šé€šè¿‡ Web Serial å†å‘ç»™å¦ä¸€å— Arduinoï¼ˆåªåœ¨ Chrome æ”¯æŒï¼‰
      // if (serialWriter) {
      //   serialWriter.write(text + '\n');
      // }
    }

    btnConnect.addEventListener('click', connectBLE);
    btnClear.addEventListener('click', () => { logDiv.textContent = ''; });
  </script>
</body>
</html>
